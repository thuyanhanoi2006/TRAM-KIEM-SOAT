<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TR·∫†M KI·ªÇM SO√ÅT Z-CORE</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
      body { margin: 0; padding: 0; background: #000; font-family: 'Arial', sans-serif; text-align: center; color: white; }
      #start-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
      #btn-start { padding: 25px 50px; font-size: 24px; background: #008000; color: white; border: 3px solid #00FF00; border-radius: 50px; font-weight: bold; cursor: pointer; box-shadow: 0 0 30px #00FF00; text-transform: uppercase; animation: pulse 1.5s infinite; }
      @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.05);} 100% {transform: scale(1);} }
      
      .main-ui { display: none; max-width: 600px; margin: 0 auto; padding: 10px; }
      .control-panel { background: #222; padding: 15px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #444; }
      label { display: block; text-align: left; color: #ccc; font-weight: bold; margin-bottom: 5px; font-size: 14px;}
      select, input[type="date"] { width: 100%; padding: 12px; font-size: 16px; font-weight: bold; background: #333; color: white; border: 1px solid #555; border-radius: 5px; outline: none; margin-bottom: 10px; box-sizing: border-box;}
      
     #scanner-container { position: relative; width: 100%; max-width: 500px; height: 350px; margin: 0 auto 15px auto; border: 3px solid #555; border-radius: 10px; overflow: hidden; background: #111; transition: border-color 0.2s;}
      #video { width: 100%; height: 100%; object-fit: cover; display: block; }
      
      #scan-region { 
        position: absolute; top: 7%; left: 7%; width: 86%; height: 86%; 
        border: 2px solid rgba(255, 255, 255, 0.4); border-radius: 15px; 
        box-shadow: 0 0 0 4000px rgba(0, 0, 0, 0.6); pointer-events: none; 
      }
 
      #status-popup { position: fixed; top: 15%; left: 50%; transform: translate(-50%, 0); width: 90%; max-width: 400px; padding: 20px; border-radius: 15px; color: white; z-index: 1000; display: none; box-shadow: 0 10px 50px rgba(0,0,0,0.9); border: 2px solid #555; }
      .icon-large { font-size: 60px; display: block; margin-bottom: 10px; }
      #popup-msg { font-size: 22px; font-weight: bold; line-height: 1.3; text-transform: uppercase; }
      #debug-voice { font-size: 14px; color: #aaa; margin-top: 10px; font-style: italic; }
      
      .input-manual { display: flex; gap: 5px; margin-top: 10px; }
      #manualInput { flex: 1; padding: 15px; font-size: 18px; border-radius: 5px; border: none; font-weight: bold; text-align: center; text-transform: uppercase; }
      .btn-send { padding: 0 20px; font-size: 18px; background: #008000; color: white; border: none; border-radius: 5px; font-weight: bold; }
      
      .status-badge { display:none; background: #ffc107; color: #000; font-weight: bold; font-size: 12px; padding: 5px 10px; border-radius: 20px; margin-bottom: 10px; animation: blinker 1s linear infinite; }
      @keyframes blinker { 50% { opacity: 0.5; } }
    </style>
  </head>
  <body>
    <div id="start-screen">
      <h1 style="color:#00FF00; font-size:30px; margin-bottom:10px;">TR·∫†M KI·ªÇM SO√ÅT</h1>
      <p style="color:#aaa; font-size:14px; margin-bottom: 30px;">(C∆° ch·∫ø chu·∫©n App Native - V8)</p>
      <button id="btn-start" onclick="startSystem()">üé• B·∫¨T M√ÅY ·∫¢NH</button>
    </div>
 
    <div id="status-popup">
      <span id="popup-icon" class="icon-large"></span>
      <div id="popup-msg"></div>
      <div id="debug-voice"></div>
    </div>
 
    <div class="main-ui" id="ui">
      <h3 style="color:#00FF00; margin-top:0;">üì° H·ªÜ TH·ªêNG ƒêANG QU√âT</h3>
      <div id="processing-badge" class="status-badge">‚è≥ƒêANG X·ª¨ L√ù... KH√ìA CAMERA</div>
      <div class="control-panel">
       <label>NG√ÄY QU√âT M√É:</label>
        <input type="date" id="scanDate">
 
       <label>CH·ªåN NHI·ªÜM V·ª§ TH·ª∞C THI:</label>
        <select id="eventSelect">
          <option value="" disabled selected>‚ö†Ô∏è H√ÉY CH·ªåN NHI·ªÜM V·ª§ TH·ª∞C THI</option>
          <option value="DIEM_DANH_NGAY">üìÖ 1. ƒêI·ªÇM DANH NG√ÄY</option>
          <option value="VE_TRANH_THU">üèÉ 2. V·ªÄ NGH·ªà TRANH TH·ª¶</option>
          <option value="LEN_DON_VI">üéí 3. L√äN ƒê∆†N V·ªä</option>
          <option value="VE_TU_TUC_T7">üè° 4. V·ªÄ T·ª∞ T√öC (Tr∆∞·ªõc ng√†y tr·∫£ qu√¢n)</option>
          <option value="VE_TU_TUC_CN">üè° 5. V·ªÄ T·ª∞ T√öC (C√πng ng√†y tr·∫£ qu√¢n)</option>
          <option value="NGHI_LE_RA">üèñÔ∏è 6. NGH·ªà L·ªÑ (Qu√©t RA)</option>
          <option value="NGHI_LE_VAO">üè´ 7. NGH·ªà L·ªÑ (Qu√©t V√ÄO)</option>
       </select>
      </div>
 
      <div id="scanner-container">
        <video id="video" autoplay muted playsinline></video>
        <div id="scan-region"></div>
      </div>
      
      <canvas id="hidden-canvas" style="display:none;"></canvas>
      
      <div class="input-manual">
        <input type="text" id="manualInput" placeholder="NH·∫¨P M√É B·∫∞NG TAY..." onkeydown="if(event.key==='Enter') handleManual()">
        <button class="btn-send" id="btnSendManual" onclick="handleManual()">OK</button>
      </div>
    </div>
    
    <script>
      // =========================================================================
      // LINK WEB APP GOOGLE SCRIPT C·ª¶A B·∫†N (GI·ªÆ NGUY√äN)
      // =========================================================================
      const GOOGLE_API_URL = "https://script.google.com/macros/s/AKfycbwnDumAjyXNfoN2gWDQjRta97h4qrSllm3MnUwCEfg43RBRndAvE0KalRUZbnKS6LlShg/exec";
 
      var video = document.getElementById("video");
      var scanRequestId = null;
      var currentStream = null;
      
      // =========================================================================
      // C∆† CH·∫æ STATE MACHINE (M√ÅY TR·∫†NG TH√ÅI) - CHU·∫®N ZALO
      // =========================================================================
      var scanState = "IDLE"; 
      var lastScannedCode = ""; 
      
      var hiddenCanvas = document.getElementById("hidden-canvas");
      var hiddenCtx = hiddenCanvas.getContext("2d", { willReadFrequently: true });
      
      var tzOffset = (new Date()).getTimezoneOffset() * 60000;
      var todayLocal = (new Date(Date.now() - tzOffset)).toISOString().slice(0, 10);
      document.getElementById('scanDate').value = todayLocal;
 
      function startSystem() {
        try { var ctx = new (window.AudioContext || window.webkitAudioContext)(); ctx.resume(); } catch(e) {}
        
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(function(stream) { startStream(stream); })
        .catch(function(err) {
            navigator.mediaDevices.getUserMedia({ video: true })
              .then(function(stream) { startStream(stream); })
              .catch(function(err2) { alert("Vui l√≤ng cho ph√©p tr√¨nh duy·ªát truy c·∫≠p M√°y ·∫£nh!"); });
          });
      }
 
      function startStream(stream) {
        document.getElementById('start-screen').style.display = 'none'; 
        document.getElementById('ui').style.display = 'block';
        try { speak("S·∫µn s√†ng qu√©t m√£."); } catch(e) {}
        
        currentStream = stream;
        video.srcObject = stream;
        video.setAttribute("playsinline", true); 
        video.play().then(() => {
            scanRequestId = requestAnimationFrame(tick);
          });
      }
 
      function tick() {
        if (scanState !== "IDLE") return; 
 
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            var scanWidth = 400; 
            var ratio = video.videoWidth / scanWidth;
            var scanHeight = Math.floor(video.videoHeight / ratio);
            
            hiddenCanvas.width = scanWidth;
            hiddenCanvas.height = scanHeight;
            
            hiddenCtx.drawImage(video, 0, 0, scanWidth, scanHeight);
            var imageData = hiddenCtx.getImageData(0, 0, scanWidth, scanHeight);
            
            var code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });
            
            if (code && code.data !== "") {
                if (code.data === lastScannedCode) {
                  scanRequestId = requestAnimationFrame(tick);
                  return; 
                }
                
              triggerScanProcessing(code.data);
              return;
            }
        }
        scanRequestId = requestAnimationFrame(tick);
      }
 
      function handleManual() { 
        if (scanState !== "IDLE") return; 
        var val = document.getElementById('manualInput').value.trim(); 
        if(val) { 
          document.getElementById('manualInput').value = '';
          document.getElementById('manualInput').blur(); 
          triggerScanProcessing(val); 
        }
      }
      
      function triggerScanProcessing(codeString) {
        scanState = "PROCESSING"; 
        lastScannedCode = codeString;
        
        document.getElementById('processing-badge').style.display = 'inline-block';
        
        var container = document.getElementById('scanner-container');
        container.style.borderColor = "#00FF00";
        setTimeout(() => container.style.borderColor = "#555", 500);
        
        beep();
        handleProcess(codeString);
      }
      
      function handleProcess(code) {
        var evt = document.getElementById('eventSelect').value;
        var dateStr = document.getElementById('scanDate').value;
        
        // KI·ªÇM TRA ƒê√É CH·ªåN NHI·ªÜM V·ª§ CH∆ØA
        if (!evt || evt === "") { 
            alert("‚ö†Ô∏è B·∫†N CH∆ØA CH·ªåN NHI·ªÜM V·ª§ TH·ª∞C THI!\nVui l√≤ng ch·ªçn nhi·ªám v·ª• tr∆∞·ªõc khi qu√©t m√£."); 
            resumeScanning(); 
            return; 
        }

        if (!dateStr) { 
            alert("Vui l√≤ng ch·ªçn ng√†y!"); 
            resumeScanning(); 
            return; 
        }
        
        showPopup('loading', 'ƒêang ghi d·ªØ li·ªáu...');
        
        var apiUrl = GOOGLE_API_URL + "?api=scan&msv=" + encodeURIComponent(code) +
        "&eventCode=" + encodeURIComponent(evt) +
        "&dateStr=" + encodeURIComponent(dateStr) + "&t=" + new Date().getTime();
        
        fetch(apiUrl)
          .then(response => response.json())
          .then(res => {
              if(res.success) { showPopup('success', res.message); } else { showPopup('error', res.message); }
              if(res.debugText) document.getElementById('debug-voice').innerText = "üîä " + res.debugText;
              if(res.audio) speak(res.audio);
               
              setTimeout(() => { 
                  hidePopup(); 
                  resumeScanning(); 
                }, 2500);
            })
            .catch(err => {
              showPopup('error', 'L·ªñI M·∫†NG HO·∫∂C M√ÅY CH·ª¶ B·∫¨N'); 
              setTimeout(() => { hidePopup(); resumeScanning(); }, 3000); 
            });
      }
 
      function resumeScanning() {
        document.getElementById('processing-badge').style.display = 'none';
        scanState = "IDLE"; 
        setTimeout(() => { lastScannedCode = ""; }, 5000);
        scanRequestId = requestAnimationFrame(tick); 
      }
 
      function showPopup(type, msg) {
        var p = document.getElementById('status-popup'); var icon = document.getElementById('popup-icon'); var txt = document.getElementById('popup-msg');
        p.style.display = 'block'; txt.innerHTML = msg; document.getElementById('debug-voice').innerText = "";
        if(type=='loading') { icon.innerHTML = '‚è≥'; p.style.background = 'rgba(0,0,0,0.85)'; }
        if(type=='success') { icon.innerHTML = '‚úÖ'; p.style.background = '#006400'; }
        if(type=='error')   { icon.innerHTML = '‚õî'; p.style.background = '#8B0000'; }
      }
      function hidePopup() { document.getElementById('status-popup').style.display = 'none'; }
      function speak(text) { window.speechSynthesis.cancel(); var msg = new SpeechSynthesisUtterance(text); msg.lang = 'vi-VN'; msg.rate = 1.1; window.speechSynthesis.speak(msg); }
      function beep() { try { var ctx = new (window.AudioContext || window.webkitAudioContext)(); var o = ctx.createOscillator(); o.type = 'sine'; o.frequency.value = 1500; o.connect(ctx.destination); o.start(); setTimeout(() => o.stop(), 100); } catch(e) {} }
    </script>
  </body>
</html>
